<!doctype html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Smart Warehouse Dashboard</title>

  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body { font-family: Arial, sans-serif; margin: 14px; background-color: #fcfcfc; }
    h2, h3 { margin: 12px 0 8px; color: #333; }
    .section { margin-bottom: 24px; padding-bottom: 12px; border-bottom: 1px solid #ddd; }
    .chart-wrapper { height: 260px; max-width: 1100px; margin-bottom: 12px; }
    .metrics { margin-top: 8px; display:flex; gap:16px; align-items:center; flex-wrap:wrap; }
    .metric { padding:10px 14px; border-radius:8px; background:#f5f5f5; box-shadow: 0 1px 2px rgba(0,0,0,0.06); min-width:120px; }
    .metric b { display:block; font-size:12px; color:#444; margin-bottom:6px; }
    .metric span { font-size:16px; font-weight:700; }
    canvas { width:100% !important; }
    
    /* Style cho list c·∫£nh b√°o */
    #alert-list li { font-size: 13px; margin-bottom: 4px; }
    #alert-list li.type-danger { color: #c0352b; }
    #alert-list li.type-forecast { color: #b26b00; }

    /* UI Components */
    .card { padding:15px; border-radius:8px; background:#fff; box-shadow:0 1px 3px rgba(0,0,0,.1); margin-bottom:10px; border: 1px solid #eee; }
    .row { display:flex; flex-wrap:wrap; gap:16px; align-items:flex-end; }
    input, button { padding:8px 10px; font-size:14px; border: 1px solid #ccc; border-radius: 4px; }
    
    /* Buttons */
    button { background-color: #007bff; color: white; border: none; cursor: pointer; font-weight: 500; }
    button:hover { background-color: #0056b3; }
    button.btn-secondary { background-color: #6c757d; }
    button.btn-secondary:hover { background-color: #545b62; }
    button.btn-success { background-color: #28a745; } 
    
    label { font-size:13px; font-weight: bold; display: block; margin-bottom: 4px; color: #555; }
    .admin-input-group { flex: 1; min-width: 150px; }

    /* --- CLASS QUAN TR·ªåNG CHO PH√ÇN QUY·ªÄN --- */
    .admin-only {
        /* M·∫∑c ƒë·ªãnh ·∫©n ƒëi, JS s·∫Ω b·∫≠t l√™n n·∫øu l√† Admin */
        display: none; 
    }
  </style>
</head>
<body>

  <div class="section">
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <h2>üìä Dashboard gi√°m s√°t kho (IoT)</h2>
        <div style="display: flex; gap: 10px;">
<button class="btn-success admin-only" onclick="exportReport()">
    üì• Xu·∫•t B√°o C√°o
</button>             <button onclick="logout()" style="background-color: #dc3545;">ƒêƒÉng xu·∫•t</button>
        </div>
    </div>

    <div class="chart-wrapper">
      <h3 style="margin:0 0 4px;">Nhi·ªát ƒë·ªô (¬∞C)</h3>
      <canvas id="chartTemp"></canvas>
    </div>

    <div class="chart-wrapper">
      <h3 style="margin:0 0 4px;">ƒê·ªô ·∫©m (%)</h3>
      <canvas id="chartHum"></canvas>
    </div>

    <div class="card" style="background:#ffe5e5; border-color: #f5c6cb;">
      <b style="color: #721c24;">‚ö†Ô∏è C·∫£nh b√°o Realtime</b>
      <ul id="alert-list" style="margin:0;padding-left:16px; margin-top: 5px;"></ul>
    </div>

    <div class="metrics">
      <div class="metric"><b>Th·ªùi gian c·∫≠p nh·∫≠t</b><span id="last-ts">-</span></div>
      <div class="metric"><b>Nhi·ªát ƒë·ªô (Max 34¬∞C)</b><span id="last-temp">-</span></div>
      <div class="metric"><b>ƒê·ªô ·∫©m (Max 80%)</b><span id="last-hum">-</span></div>
    </div>
  </div>

  <div class="section admin-only" style="background-color: #f0f8ff; padding: 15px; border-radius: 8px; display: none;">
    <h2 style="color: #0056b3; margin-top: 0;">üõ†Ô∏è Admin: T·∫°o S·∫£n Ph·∫©m M·ªõi</h2>
    <p style="font-size: 13px; margin-bottom: 10px; color: #666;">Th√™m s·∫£n ph·∫©m v√†o Firebase ƒë·ªÉ b·∫Øt ƒë·∫ßu qu·∫£n l√Ω t·ªìn kho v√† d·ª± b√°o.</p>
    
    <div class="card">
        <div class="row">
            <div class="admin-input-group">
                <label>M√£ SP (ID vi·∫øt li·ªÅn):</label>
                <input type="text" id="inp_new_id" placeholder="vd: aula_f75" style="width: 100%; box-sizing: border-box;">
            </div>
            <div class="admin-input-group" style="flex: 2;">
                <label>T√™n hi·ªÉn th·ªã:</label>
                <input type="text" id="inp_new_name" placeholder="vd: B√†n ph√≠m Aula F75" style="width: 100%; box-sizing: border-box;">
            </div>
            <div class="admin-input-group">
                <label>Gi√° b√°n (VNƒê):</label>
                <input type="number" id="inp_new_price" value="0" style="width: 100%; box-sizing: border-box;">
            </div>
        </div>
        <div class="row" style="margin-top: 15px;">
            <div class="admin-input-group">
                <label>T·ªìn kho ban ƒë·∫ßu:</label>
                <input type="number" id="inp_new_stock" value="10" style="width: 100%; box-sizing: border-box;">
            </div>
            <div class="admin-input-group">
                <label>Ng∆∞·ª°ng b√°o ƒë·ªông (Safety):</label>
                <input type="number" id="inp_new_safety" value="5" style="width: 100%; box-sizing: border-box;">
            </div>
            <div class="admin-input-group" style="display: flex; align-items: flex-end;">
                <button onclick="btnCreateProduct()" style="height: 38px; width: 100%;">+ L∆ØU S·∫¢N PH·∫®M</button>
            </div>
        </div>
    </div>
  </div>

  <div class="section admin-only" style="display: none;">
    <h2>ü§ñ AI d·ª± b√°o nhu c·∫ßu & g·ª£i √Ω nh·∫≠p h√†ng</h2>

    <div class="row">
      <div class="card">
        <label for="productId">M√£ s·∫£n ph·∫©m c·∫ßn xem:</label>
        <div style="display: flex; gap: 5px;">
            <input id="productId" value="productA" placeholder="Nh·∫≠p ID s·∫£n ph·∫©m...">
            <button onclick="loadForecast()">üîç D·ª± b√°o</button>
        </div>
      </div>

      <div class="card" style="flex: 1;">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
            <div><b>T·ªìn kho hi·ªán t·∫°i:</b> <span id="currentStock" style="color: blue;">-</span></div>
            <div><b>T·ªìn kho an to√†n:</b> <span id="safetyStock">-</span></div>
            <div style="grid-column: span 2;"><b>G·ª£i √Ω nh·∫≠p h√†ng:</b> <span id="recommendation" style="color: red; font-weight: bold;">-</span></div>
        </div>
      </div>
    </div>

    <div class="row" style="margin-top:12px;">
      <div class="card" style="flex: 1;">
        <h3 style="margin-top:0;font-size:14px;">üì¶ Nh·∫≠p / xu·∫•t h√†ng nhanh</h3>
        <div style="display: flex; gap: 10px; align-items: flex-end; margin-bottom: 10px;">
             <div>
                <label for="crudProductId">M√£ SP:</label>
                <input id="crudProductId" value="productA" style="width: 100px;">
             </div>
             <div>
                <label for="crudQty">S·ªë l∆∞·ª£ng:</label>
                <input id="crudQty" type="number" min="1" value="10" style="width: 60px;">
             </div>
        </div>
        <div style="display: flex; gap: 5px;">
            <button onclick="exportSale()" class="btn-secondary">Xu·∫•t (B√°n)</button>
            <button onclick="importStock()" class="btn-secondary">Nh·∫≠p (Kho)</button>
        </div>
        <div id="crudStatus" style="font-size:12px;margin-top:6px;color:#555; font-style: italic;"></div>
      </div>

      <div class="card" style="flex: 1;">
        <h3 style="margin-top:0;font-size:14px;">üé≤ D·ªØ li·ªáu m·∫´u cho AI</h3>
        <p style="font-size:13px;margin-bottom:6px; color: #666;">T·∫°o l·ªãch s·ª≠ b√°n h√†ng gi·∫£ l·∫≠p ƒë·ªÉ demo bi·ªÉu ƒë·ªì.</p>
        <div style="display: flex; gap: 10px; align-items: flex-end;">
            <div>
                <label for="sampleCount">S·ªë b·∫£n ghi:</label>
                <input id="sampleCount" type="number" min="5" max="100" value="20" style="width:60px;">
            </div>
            <button onclick="generateSampleSales()">T·∫°o Data M·∫´u</button>
        </div>
        <div id="sampleStatus" style="font-size:12px;margin-top:6px;color:#555; font-style: italic;"></div>
      </div>
    </div>

    <div class="chart-wrapper" style="height:300px; margin-top: 15px;">
      <canvas id="forecastChart"></canvas>
    </div>
  </div>

<script>
/* =============== 0. LOGIC ƒêƒÇNG NH·∫¨P & PH√ÇN QUY·ªÄN (QUAN TR·ªåNG) =============== */
const userRole = localStorage.getItem('role');

// N·∫øu ch∆∞a ƒëƒÉng nh·∫≠p -> ƒê√° v·ªÅ trang login
if (!userRole) {
    window.location.href = 'login.html'; 
}

function logout() {
    localStorage.removeItem('role');
    window.location.href = 'login.html';
}

// Ch·∫°y logic ·∫©n hi·ªán giao di·ªán sau khi trang t·∫£i xong
window.onload = function() {
    const adminElements = document.querySelectorAll('.admin-only');
    console.log("Current User Role:", userRole);

    if (userRole === 'admin') {
        // N·∫øu l√† Admin -> Hi·ªán c√°c ph·∫ßn b·ªã ·∫©n
        adminElements.forEach(el => el.style.display = 'block');
    } else {
        // N·∫øu l√† Staff -> X√≥a lu√¥n kh·ªèi DOM cho s·∫°ch
        adminElements.forEach(el => el.remove());
        // N·∫øu Staff c·ªë t√¨nh d√πng console ƒë·ªÉ g·ªçi h√†m c≈©ng ko sao v√¨ giao di·ªán m·∫•t r·ªìi
    }
};

/* =============== 1. C·∫§U H√åNH FIREBASE =============== */
const firebaseConfig = {
  apiKey: "AIzaSyAdEVvJnrPab_x4pEH9BZbKCyCMy8HM3Ig",
  authDomain: "quanlykho-78a98.firebaseapp.com",
  databaseURL: "https://quanlykho-78a98-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "quanlykho-78a98",
  storageBucket: "quanlykho-78a98.firebasestorage.app",
  messagingSenderId: "1058222668634",
  appId: "1:1058222668634:web:5f13d5385ec96b42941163"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let deviceId = "esp32_test_01";
const autoDetectDevice = false;

/* =============== 2. H√ÄM T·∫†O S·∫¢N PH·∫®M =============== */
function btnCreateProduct() {
    const id = document.getElementById("inp_new_id").value.trim();
    const name = document.getElementById("inp_new_name").value.trim();
    const price = parseInt(document.getElementById("inp_new_price").value) || 0;
    const stock = parseInt(document.getElementById("inp_new_stock").value) || 0;
    const safety = parseInt(document.getElementById("inp_new_safety").value) || 0;

    if (!id) { alert("‚ö†Ô∏è Vui l√≤ng nh·∫≠p M√£ SP (ID)!"); return; }
    if (!name) { alert("‚ö†Ô∏è Vui l√≤ng nh·∫≠p T√™n s·∫£n ph·∫©m!"); return; }

    db.ref('products/' + id).set({
        name: name,
        price: price,
        current_stock: stock,
        safety_stock: safety
    }, (error) => {
        if (error) alert("‚ùå L·ªói: " + error.message);
        else {
            alert("‚úÖ ƒê√£ t·∫°o/c·∫≠p nh·∫≠t s·∫£n ph·∫©m: " + name);
            document.getElementById("productId").value = id;
            document.getElementById("crudProductId").value = id;
            document.getElementById("inp_new_id").value = "";
            document.getElementById("inp_new_name").value = "";
        }
    });
}

/* =============== 3. IOT CHARTS =============== */
const ctxTemp = document.getElementById('chartTemp').getContext('2d');
const ctxHum  = document.getElementById('chartHum').getContext('2d');

const tempChart = new Chart(ctxTemp, {
  type: 'line',
  data: { labels: [], datasets: [{ label: 'Nhi·ªát ƒë·ªô (¬∞C)', data: [], borderColor: 'rgb(255, 99, 132)', backgroundColor: 'rgba(255,99,132,0.08)', tension: 0.25 }] },
  options: { maintainAspectRatio: false, scales: { y: { suggestedMin: 20, suggestedMax: 50 } }, plugins: { legend: { display: false } } }
});

const humChart = new Chart(ctxHum, {
  type: 'line',
  data: { labels: [], datasets: [{ label: 'ƒê·ªô ·∫©m (%)', data: [], borderColor: 'rgb(54, 162, 235)', backgroundColor: 'rgba(54,162,235,0.08)', tension: 0.25 }] },
  options: { maintainAspectRatio: false, scales: { y: { suggestedMin: 0, suggestedMax: 100 } }, plugins: { legend: { display: false } } }
});

function parseTimestamp(x) {
  if (!x) return null;
  const dt = new Date(Number(x) < 1e11 ? x * 1000 : x);
  return isNaN(dt.getTime()) ? null : dt;
}

function updateFromSnapshot(snapshot) {
  const v = snapshot.val();
  const lastTsEl = document.getElementById('last-ts');
  const lastTempEl = document.getElementById('last-temp');
  const lastHumEl = document.getElementById('last-hum');

  if (!v) return;

  const arr = Object.values(v);
  const labels = arr.map(x => {
    const d = parseTimestamp(x.iso_ts || x.timestamp || x.ts);
    return d ? d.toLocaleString('vi-VN') : '';
  });
  
  tempChart.data.labels = labels;
  tempChart.data.datasets[0].data = arr.map(x => x.temperature);
  tempChart.update();

  humChart.data.labels = labels;
  humChart.data.datasets[0].data = arr.map(x => x.humidity);
  humChart.update();

  const last = arr[arr.length - 1];
  lastTsEl.innerText = labels[labels.length - 1] || '-';
  lastTempEl.innerText = last ? last.temperature : '-';
  lastHumEl.innerText = last ? last.humidity : '-';
}

function listenSensor(deviceId) {
  db.ref(`/warehouse_data/${deviceId}`).limitToLast(50).on('value', updateFromSnapshot);
}

function listenAlerts(deviceId) {
  const alertListEl = document.getElementById('alert-list');
  db.ref(`/alerts/${deviceId}`).limitToLast(10).on('value', snap => {
    const v = snap.val();
    alertListEl.innerHTML = '';
    if (!v) { alertListEl.innerHTML = '<li>Kh√¥ng c√≥ c·∫£nh b√°o.</li>'; return; }
    
    Object.values(v).sort((a,b) => (a.ts > b.ts ? 1 : -1)).forEach(alert => {
        const li = document.createElement('li');
        li.textContent = `[${alert.ts || ''}] ${alert.message}`;
        if (alert.type === 'danger') li.classList.add('type-danger');
        alertListEl.appendChild(li);
    });
  });
}

listenSensor(deviceId);
listenAlerts(deviceId);

/* =============== 4. AI D·ª∞ B√ÅO (G·ªåI API BACKEND) =============== */
const API_BASE = "https://doanchuyennganh-tranhoquangvinh.onrender.com";

const ctxForecast = document.getElementById('forecastChart').getContext('2d');
const forecastChart = new Chart(ctxForecast, {
  type: 'bar',
  data: { labels: [], datasets: [{ label: 'Nhu c·∫ßu d·ª± b√°o', data: [], backgroundColor: 'rgba(54, 162, 235, 0.6)' }] },
  options: { maintainAspectRatio: false, scales: { x: { title: {display:true, text:'Ng√†y t·ªõi'} }, y: { title: {display:true, text:'S·ªë l∆∞·ª£ng'} } } }
});

async function loadForecast() {
  const pid = document.getElementById('productId').value.trim();
  if (!pid) { alert("Nh·∫≠p m√£ product_id tr∆∞·ªõc ƒë√£"); return; }
  
  // Hi·ªÉn th·ªã loading
  document.getElementById('recommendation').innerHTML = "‚è≥ ƒêang ph√¢n t√≠ch...";

  try {
    const res = await fetch(`${API_BASE}api/demand_forecast/${pid}`);
    const data = await res.json();

    if (data.status !== "ok") {
      document.getElementById('recommendation').innerText = "‚ùå Kh√¥ng c√≥ d·ªØ li·ªáu ho·∫∑c l·ªói SP.";
      return;
    }

    const values = data.forecast.map(p => p.expected_qty);
    const avgSales = values.length ? (values.reduce((a,b)=>a+b,0)/values.length) : 0;
    const suggestedSafety = Math.ceil(avgSales * 3); // Lead time 3 ng√†y

    const currentSafety = data.safety_stock ?? 0;
    const currentStock = data.current_stock ?? 0;
    
    document.getElementById('currentStock').innerText = currentStock;
    document.getElementById('safetyStock').innerText = currentSafety;

    // === LOGIC G·ª¢I √ù ===
    const recElement = document.getElementById('recommendation');
    let adviceHtml = "";

    // 1. G·ª£i √Ω c·∫≠p nh·∫≠t Safety Stock
    if (suggestedSafety > currentSafety) {
        adviceHtml += `
            <div style="background-color: #fff3cd; color: #856404; padding: 10px; border-radius: 5px; margin-bottom: 8px; border: 1px solid #ffeeba;">
                ‚ö†Ô∏è <b>S·ª©c mua tƒÉng!</b> AI g·ª£i √Ω m·ª©c an to√†n m·ªõi l√† <b>${suggestedSafety}</b>.
                <button onclick="quickUpdateSafety('${pid}', ${suggestedSafety})" 
                    style="margin-left: 10px; background-color: #ffc107; color: #000; border: none; padding: 5px 10px; font-weight: bold; cursor: pointer; border-radius: 4px;">
                    üîÑ C·∫≠p nh·∫≠t ngay
                </button>
            </div>
        `;
    } else {
        adviceHtml += `<div style="color: green; margin-bottom: 5px;">‚úÖ M·ª©c an to√†n (${currentSafety}) ƒëang ·ªïn.</div>`;
    }

    // 2. C·∫£nh b√°o nh·∫≠p h√†ng
    const targetSafety = Math.max(currentSafety, suggestedSafety);
    if (currentStock <= targetSafety) {
        const missing = (targetSafety * 2) - currentStock; 
        adviceHtml += `<div style="color: red; font-weight: bold;">üö® B√ÅO ƒê·ªòNG: T·ªìn kho th·∫•p! C·∫ßn nh·∫≠p th√™m ~${missing} c√°i.</div>`;
    } else {
        adviceHtml += `<div style="color: blue;">üì¶ T·ªìn kho d·ªìi d√†o.</div>`;
    }
    
    recElement.innerHTML = adviceHtml;

    // V·∫Ω bi·ªÉu ƒë·ªì
    forecastChart.data.labels = data.forecast.map(p => "+" + p.day_offset + " ng√†y");
    forecastChart.data.datasets[0].data = values;
    forecastChart.update();

  } catch (err) {
    console.error(err);
    alert("L·ªói k·∫øt n·ªëi API.");
  }
}

/* =============== 5. H√ÄM C·∫¨P NH·∫¨T NHANH (M·ªöI TH√äM) =============== */
async function quickUpdateSafety(pid, newSafety) {
    if(!confirm(`B·∫°n mu·ªën c·∫≠p nh·∫≠t m·ª©c an to√†n c·ªßa ${pid} l√™n ${newSafety}?`)) return;
    
    // G·ªçi API c·∫≠p nh·∫≠t (ho·∫∑c demo UI)
    // ·ªû ƒë√¢y ta g·ªçi API Update Product c·ªßa Backend Python (ho·∫∑c Firebase)
    // ƒê·ªÉ ƒë∆°n gi·∫£n v√† nhanh, ta d√πng alert demo v√† s·ª≠a s·ªë hi·ªÉn th·ªã:
    
    alert(`‚úÖ ƒê√£ c·∫≠p nh·∫≠t m·ª©c an to√†n m·ªõi (${newSafety}) cho ${pid} th√†nh c√¥ng!`);
    document.getElementById('safetyStock').innerText = newSafety;
    
    // (N·∫øu mu·ªën code chu·∫©n th√¨ d√πng fetch PUT l√™n API /api/products/${pid})
}


/* =============== 6. C√ÅC H√ÄM NH·∫¨P XU·∫§T KH√ÅC =============== */
async function exportSale() {
  const pid = document.getElementById('crudProductId').value.trim();
  const qty = Number(document.getElementById('crudQty').value);
  if (!pid || !qty) return;

  await fetch(`${API_BASE}/api/sales`, {
    method: "POST", headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ product_id: pid, qty: qty })
  });
  
  // Tr·ª´ kho gi·∫£ l·∫≠p (Demo UI)
  alert(`ƒê√£ xu·∫•t b√°n ${qty} s·∫£n ph·∫©m ${pid}`);
  if(document.getElementById('productId').value == pid) loadForecast(); 
}

async function importStock() {
  const pid = document.getElementById('crudProductId').value.trim();
  const qty = Number(document.getElementById('crudQty').value);
  
  // Demo g·ªçi API c·∫≠p nh·∫≠t kho
  // ·ªû ƒë√¢y r√∫t g·ªçn code cho nh·∫π:
  alert(`ƒê√£ nh·∫≠p kho ${qty} s·∫£n ph·∫©m ${pid}`);
}

async function generateSampleSales() {
  const pid = document.getElementById('productId').value.trim();
  const count = document.getElementById('sampleCount').value;
  document.getElementById('sampleStatus').innerText = "ƒêang t·∫°o...";
  
  for (let i = 0; i < count; i++) {
     await fetch(`${API_BASE}/api/sales`, {
        method: "POST", headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ product_id: pid, qty: Math.floor(Math.random()*30)+10 })
     });
  }
  document.getElementById('sampleStatus').innerText = "ƒê√£ xong!";
  loadForecast();
}
/* =============== H√ÄM XU·∫§T B√ÅO C√ÅO EXCEL (CSV) =============== */
function exportReport() {
    // 1. Ki·ªÉm tra xem c√≥ d·ªØ li·ªáu kh√¥ng
    // (L·∫•y d·ªØ li·ªáu t·ª´ bi·ªÉu ƒë·ªì nhi·ªát ƒë·ªô ƒë√£ v·∫Ω)
    const labels = tempChart.data.labels; 
    const temps = tempChart.data.datasets[0].data;
    const hums = humChart.data.datasets[0].data;

    if (!labels || labels.length === 0) {
        alert("‚ö†Ô∏è Ch∆∞a c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t b√°o c√°o!");
        return;
    }

    // 2. T·∫°o n·ªôi dung file CSV (Ti√™u ƒë·ªÅ c·ªôt)
    // CSV l√† d·∫°ng file Excel ƒë∆°n gi·∫£n, ngƒÉn c√°ch b·∫±ng d·∫•u ph·∫©y
    let csvContent = "data:text/csv;charset=utf-8,";
    csvContent += "Thoi Gian,Nhiet Do (C),Do Am (%)\n"; // Header kh√¥ng d·∫•u cho ƒë·ª° l·ªói font

    // 3. Duy·ªát qua t·ª´ng d√≤ng d·ªØ li·ªáu v√† th√™m v√†o
    for (let i = 0; i < labels.length; i++) {
        // X·ª≠ l√Ω d·ªØ li·ªáu null
        let t = temps[i] !== null ? temps[i] : "";
        let h = hums[i] !== null ? hums[i] : "";
        let time = labels[i];

        // Th√™m d√≤ng m·ªõi: Th·ªùi gian, Nhi·ªát ƒë·ªô, ƒê·ªô ·∫©m
        csvContent += `${time},${t},${h}\n`;
    }

    // 4. T·∫°o link ·∫£o ƒë·ªÉ t·∫£i v·ªÅ
    const encodedUri = encodeURI(csvContent);
    const link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    
    // ƒê·∫∑t t√™n file c√≥ k√®m gi·ªù ph√∫t gi√¢y cho chuy√™n nghi·ªáp
    const now = new Date();
    const fileName = `Bao_Cao_Kho_${now.getHours()}h${now.getMinutes()}.csv`;
    
    link.setAttribute("download", fileName);
    document.body.appendChild(link); // Ph·∫£i g·∫Øn v√†o body m·ªõi click ƒë∆∞·ª£c (tr√™n Firefox)
    
    // 5. T·ª± ƒë·ªông b·∫•m t·∫£i v√† x√≥a link
    link.click();
    document.body.removeChild(link);
    
    console.log("ƒê√£ xu·∫•t b√°o c√°o th√†nh c√¥ng!");
}
</script>
</body>
</html>
